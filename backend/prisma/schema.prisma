generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ───────────────── ENUMS ─────────────────

enum Role {
  ADMIN
  VIEWER
}

enum FieldType {
  PROPIO
  ALQUILADO
}

enum StockMovementType {
  HARVEST
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
  INTERNAL_CONSUMPTION
}

enum LivestockMovementType {
  INCOME
  SALE
  DEATH
  TRANSFER
  ADJUSTMENT
}

enum LivestockCategory {
  TERNEROS
  NOVILLOS
  VACAS
  TOROS
}

enum Currency {
  ARS
  USD
}

enum FinancialDirection {
  INCOME
  EXPENSE
}

enum ObligationType {
  RENT
  CREDIT
  SUPPLIER
  OTHER
}

enum ObligationStatus {
  PENDING
  PAID
}

// ───────────────── USERS ─────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ───────────────── FIELDS ─────────────────

model Field {
  id        String    @id @default(uuid())
  name      String
  type      FieldType
  createdAt DateTime  @default(now()) @map("created_at")

  lots Lot[]

  @@map("fields")
}

// ───────────────── LOTS ─────────────────

model Lot {
  id        String   @id @default(uuid())
  fieldId   String   @map("field_id")
  surfaceHa Decimal  @map("surface_ha") @db.Decimal(10, 2)
  location  String?
  createdAt DateTime @default(now()) @map("created_at")

  field          Field           @relation(fields: [fieldId], references: [id])
  campaigns      Campaign[]
  stockMovements StockMovement[]

  @@map("lots")
}

// ───────────────── CAMPAIGNS ─────────────────

model Campaign {
  id        String   @id @default(uuid())
  lotId     String   @map("lot_id")
  year      Int
  crop      String
  createdAt DateTime @default(now()) @map("created_at")

  lot                Lot                 @relation(fields: [lotId], references: [id])
  stockMovements     StockMovement[]
  financialMovements FinancialMovement[]

  @@map("campaigns")
}

// ───────────────── STOCK MOVEMENTS ─────────────────

model StockMovement {
  id           String            @id @default(uuid())
  product      String
  movementType StockMovementType @map("movement_type")
  quantity     Decimal           @db.Decimal(14, 2)
  unit         String
  lotId        String?           @map("lot_id")
  campaignId   String?           @map("campaign_id")
  createdAt    DateTime          @default(now()) @map("created_at")

  lot                Lot?                @relation(fields: [lotId], references: [id])
  campaign           Campaign?           @relation(fields: [campaignId], references: [id])
  financialMovements FinancialMovement[]

  @@index([product])
  @@map("stock_movements")
}

// ───────────────── FINANCIAL MOVEMENTS ─────────────────

model FinancialMovement {
  id                     String             @id @default(uuid())
  direction              FinancialDirection
  category               String?
  amount                 Decimal            @db.Decimal(14, 2)
  currency               Currency
  exchangeRateAtCreation Decimal            @map("exchange_rate_at_creation") @db.Decimal(14, 6)
  baseCurrencyAmount     Decimal            @map("base_currency_amount") @db.Decimal(14, 2)

  stockMovementId String?        @map("stock_movement_id")
  stockMovement   StockMovement? @relation(fields: [stockMovementId], references: [id])

  campaignId String?   @map("campaign_id")
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([stockMovementId])
  @@index([campaignId])
  @@map("financial_movements")
}

// ───────────────── LIVESTOCK MOVEMENTS ─────────────────

model LivestockMovement {
  id         String                @id @default(uuid())
  date       DateTime              @db.Date
  category   LivestockCategory
  type       LivestockMovementType
  quantity   Int
  totalPrice Decimal?              @map("total_price") @db.Decimal(14, 2)
  notes      String?
  createdAt  DateTime              @default(now()) @map("created_at")

  @@map("livestock_movements")
}

// ───────────────── OBLIGATIONS ─────────────────

model Obligation {
  id                  String           @id @default(uuid())
  concept             String
  amount              Decimal          @db.Decimal(14, 2)
  dueDate             DateTime         @map("due_date") @db.Date
  type                ObligationType
  status              ObligationStatus
  financialMovementId String?          @map("financial_movement_id")
  createdAt           DateTime         @default(now()) @map("created_at")

  @@map("obligations")
}
