generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ───────────────── ENUMS ─────────────────

enum Role {
  ADMIN
  VIEWER
}

enum FieldType {
  PROPIO
  ALQUILADO
}

enum StockMovementType {
  HARVEST
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
  INTERNAL_CONSUMPTION
}

enum LivestockMovementType {
  INCOME
  SALE
  DEATH
  TRANSFER
  ADJUSTMENT
}

enum InputMovementType {
  PURCHASE
  USAGE
  ADJUSTMENT
}

enum Currency {
  ARS
  USD
}

enum InstallmentStatus {
  PENDING
  PAID
  PARTIAL
}

enum FinancialDirection {
  INCOME
  EXPENSE
}

enum MarketPriceType {
  GRAIN
  CATTLE
  USD
}

enum MarketPriceSource {
  MANUAL
  API
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// ───────────────── USERS ─────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  auditLogs AuditLog[]

  @@map("users")
}

// ───────────────── FIELDS ─────────────────

model Field {
  id        String    @id @default(uuid())
  name      String
  type      FieldType
  createdAt DateTime  @default(now()) @map("created_at")

  lots Lot[]

  @@map("fields")
}

// ───────────────── LOTS ─────────────────

model Lot {
  id        String   @id @default(uuid())
  fieldId   String   @map("field_id")
  surfaceHa Decimal  @map("surface_ha") @db.Decimal(10, 2)
  location  String?
  createdAt DateTime @default(now()) @map("created_at")

  field          Field           @relation(fields: [fieldId], references: [id])
  campaigns      Campaign[]
  stockMovements StockMovement[]

  @@map("lots")
}

// ───────────────── CAMPAIGNS ─────────────────

model Campaign {
  id        String   @id @default(uuid())
  lotId     String   @map("lot_id")
  year      Int
  crop      String
  createdAt DateTime @default(now()) @map("created_at")

  lot                Lot               @relation(fields: [lotId], references: [id])
  stockMovements     StockMovement[]
  financialMovements FinancialMovement[]

  @@map("campaigns")
}

// ───────────────── STOCK MOVEMENTS ─────────────────

model StockMovement {
  id           String            @id @default(uuid())
  product      String
  movementType StockMovementType @map("movement_type")
  quantity     Decimal           @db.Decimal(14, 2)
  unit         String
  lotId        String?           @map("lot_id")
  campaignId   String?           @map("campaign_id")
  createdAt    DateTime          @default(now()) @map("created_at")

  lot                Lot?               @relation(fields: [lotId], references: [id])
  campaign           Campaign?          @relation(fields: [campaignId], references: [id])
  financialMovements FinancialMovement[]

  @@index([product])
  @@map("stock_movements")
}

// ───────────────── FINANCIAL MOVEMENTS ─────────────────

model FinancialMovement {
  id                     String   @id @default(uuid())
  direction              FinancialDirection
  category               String?
  amount                 Decimal  @db.Decimal(14, 2)
  currency               Currency
  exchangeRateAtCreation Decimal  @map("exchange_rate_at_creation") @db.Decimal(14, 6)
  baseCurrencyAmount     Decimal  @map("base_currency_amount") @db.Decimal(14, 2)

  stockMovementId String? @map("stock_movement_id")
  stockMovement   StockMovement? @relation(fields: [stockMovementId], references: [id])

  campaignId String? @map("campaign_id")
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  loanInstallment LoanInstallment?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([stockMovementId])
  @@index([campaignId])
  @@map("financial_movements")
}

// ───────────────── LOANS ─────────────────

model Loan {
  id                     String   @id @default(uuid())
  bank                   String
  principalAmount        Decimal  @map("principal_amount") @db.Decimal(14, 2)
  currency               Currency
  exchangeRateAtCreation Decimal  @map("exchange_rate_at_creation") @db.Decimal(14, 6)
  baseCurrencyAmount     Decimal  @map("base_currency_amount") @db.Decimal(14, 2)
  interestRate           Decimal  @map("interest_rate") @db.Decimal(5, 2)
  totalInstallments      Int      @map("total_installments")
  startDate              DateTime @map("start_date") @db.Date
  createdAt              DateTime @default(now()) @map("created_at")

  installments LoanInstallment[]

  @@map("loans")
}

// ───────────────── LOAN INSTALLMENTS ─────────────────

model LoanInstallment {
  id                         String            @id @default(uuid())
  loanId                     String            @map("loan_id")
  installmentNumber          Int               @map("installment_number")
  capitalAmount              Decimal           @map("capital_amount") @db.Decimal(14, 2)
  interestAmount             Decimal           @map("interest_amount") @db.Decimal(14, 2)
  currency                   Currency
  exchangeRateAtCreation     Decimal           @map("exchange_rate_at_creation") @db.Decimal(14, 6)
  baseCurrencyCapitalAmount  Decimal           @map("base_currency_capital_amount") @db.Decimal(14, 2)
  baseCurrencyInterestAmount Decimal           @map("base_currency_interest_amount") @db.Decimal(14, 2)
  baseCurrencyAmount         Decimal           @map("base_currency_amount") @db.Decimal(14, 2)
  dueDate                    DateTime          @map("due_date") @db.Date
  status                     InstallmentStatus

  financialMovementId String? @unique @map("financial_movement_id")
  createdAt DateTime @default(now()) @map("created_at")

  loan              Loan               @relation(fields: [loanId], references: [id])
  financialMovement FinancialMovement? @relation(fields: [financialMovementId], references: [id])

  @@index([dueDate])
  @@index([loanId])
  @@map("loan_installments")
}

// ───────────────── AUDIT LOG ─────────────────

model AuditLog {
  id              String      @id @default(uuid())
  entityType      String      @map("entity_type")
  entityId        String      @map("entity_id")
  action          AuditAction
  changedByUserId String      @map("changed_by_user_id")
  createdAt       DateTime    @default(now()) @map("created_at")

  changedBy User @relation(fields: [changedByUserId], references: [id])

  @@index([entityType, entityId])
  @@map("audit_logs")
}